<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Friend Finder Flasher</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f4f7f9;
            --text-color: #333;
            --primary-color: #007bff;
            --container-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        main {
            background-color: var(--container-bg);
            max-width: 700px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: left;
        }

        h1 {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
        }

        p {
            line-height: 1.6;
        }
        
        .intro {
            text-align: center;
            color: #555;
            margin-bottom: 30px;
        }

        .section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        h2 {
            font-size: 1.2em;
            font-weight: 600;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 15px;
        }

        ul, ol {
            padding-left: 20px;
        }

        li {
            margin-bottom: 8px;
        }

        .button-container {
            text-align: center;
            margin: 40px 0;
        }
        
        /* New styles for the device selection dropdown */
        .select-container {
            margin-bottom: 25px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .select-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            text-align: center;
        }

        .select-container select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            background-color: #fafafa;
        }

        esp-web-install-button button {
            background-color: var(--primary-color);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        esp-web-install-button button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .options-container {
            margin-top: 20px;
            font-size: 0.9em;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .options-container input {
            margin-right: 6px;
            width: 1.1em;
            height: 1.1em;
        }
        
        .options-container input:disabled + label {
            color: #aaa;
            cursor: not-allowed;
        }

        .backup-notice {
            background-color: #fffbe6;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 25px 0 0 0;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .backup-notice p {
            margin: 0;
        }

        .backup-notice p:first-child {
            margin-bottom: 8px;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        footer {
            margin-top: 50px;
            text-align: center;
            color: #777;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <main>
        <h1>Friend Finder Firmware Flasher</h1>
        <p class="intro">
            Install the custom Meshtastic firmware with Friend Finder & Magnetometer support directly to your device.
        </p>
        
        <div class="button-container">
            <div class="select-container">
                <label for="device-select">1. Select Your Device</label>
                <select id="device-select"></select>
            </div>

            <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>

            <esp-web-install-button id="flasherButton">
                <button id="activateBtn" slot="activate">2. Connect & Install Firmware</button>
            </esp-web-install-button>
            
            <div class="options-container">
                <input type="checkbox" id="skipErase" name="skipErase" disabled />
                <label for="skipErase">Skip full erase (coming soon)</label>
            </div>
            
            <div class="backup-notice">
                <p><strong>Important:</strong> The "skip erase" feature will be added soon. For now, flashing the firmware will perform a <strong>full erase</strong> of the device.</p>
                <p>Please back up your settings and channel keys using the Meshtastic app or CLI before you proceed.</p>
            </div>
        </div>

        <div class="section">
            <h2>üöÄ Key Features</h2>
            <ul>
                <li><strong>Real-Time Tracking:</strong> See the distance and direction to your friends.</li>
                <li><strong>Compass Support:</strong> Adds magnetometer support for a directional arrow.</li>
                <li><strong>Friend Map:</strong> View all your paired friends on a map screen.</li>
                <li><strong>Designed for the Outdoors:</strong> Perfect for festivals, skiing, and hiking.</li>
            </ul>
        </div>

        <div class="section">
            <h2>üìã Instructions</h2>
            <ol>
                <li>Select your device from the dropdown menu above.</li>
                <li>Plug your device into your computer.</li>
                <li>Click the <strong>Connect & Install</strong> button.</li>
                <li>Select the correct <strong>COM/Serial Port</strong> from the pop-up window and click ‚ÄúConnect‚Äù.</li>
                <li>The installation will begin. Keep this browser tab open until it completes.</li>
            </ol>
        </div>
        
        <div class="section">
            <h2>‚öôÔ∏è Hardware Requirements</h2>
            <p>
                This firmware is designed for ESP32-S3 devices like the <strong>Heltec V3</strong> or <strong>LILYGO T-Lora T3-S3</strong> and requires a <strong>GPS module</strong> to function. For the directional arrow feature, a <strong>QMC5883L magnetometer</strong> is also needed.
            </p>
            <p>
                Please <a href="https://github.com/LeapYeet/Meshtastic-Firmware-Friend-Finder-Edition/blob/main/README.md" target="_blank"><strong>read the project's README file carefully</strong></a> for important details on wiring the components and performing the essential compass calibration to ensure accuracy.
            </p>
        </div>

        <div class="section">
            <h2>üìÑ Source Code & Documentation</h2>
            <p>
                You can find the source code, full documentation, and project updates on GitHub.
            </p>
            <ul>
                <li><a href="https://github.com/LeapYeet/firmware" target="_blank"><strong>Firmware Fork on GitHub</strong></a> - The main source code for this project.</li>
                <li><a href="https://github.com/LeapYeet/Meshtastic-Firmware-Friend-Finder-Edition" target="_blank"><strong>Web Flasher Repository</strong></a> - The code for this installation page.</li>
            </ul>
        </div>

        <div class="section">
            <h2>Warning</h2>
            <p>
                Flashing firmware can potentially brick your device. Ensure you have the correct firmware for your specific model and follow all instructions carefully. This firmware is experimental and may have bugs. Use at your own risk.
            </p>
        </div>
    </main>
    
    <footer>
      <p>
        If you find this project useful, consider supporting its development!
      </p>
      <a href="https://ko-fi.com/LeapYeet" target="_blank" title="Support me on Ko-fi">
        <img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;">
      </a>
    </footer>

    <script>
        // Helper to sync both the property and the attribute that esp-web-tools understands
        function applyEraseMode(buttonEl, skipErase) {
            const eraseFirst = !skipErase;
            buttonEl.eraseFirst = eraseFirst;
            if (eraseFirst) {
                buttonEl.setAttribute('erase-first', '');
            } else {
                buttonEl.removeAttribute('erase-first');
            }
            console.log(`[FF Flasher] eraseFirst=${eraseFirst} (skipErase=${skipErase})`);
        }

        // Wait until the custom element is defined
        customElements.whenDefined('esp-web-install-button').then(() => {
            const flasherButton     = document.getElementById('flasherButton');
            const deviceSelect      = document.getElementById('device-select');
            const skipEraseCheckbox = document.getElementById('skipErase');
            const activateBtn       = document.getElementById('activateBtn');

            // --- Define your supported devices here ---
            const devices = [
                {
                    name: "Heltec V3",
                    manifest: "firmware/heltec_v3/manifest.json"
                },
                {
                    name: "LILYGO T-Lora T3-S3",
                    manifest: "firmware/tlora_t3s3_v1/manifest.json"
                }
      
            ];

            // --- Logic to populate and manage the device dropdown ---
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.manifest;
                option.textContent = device.name;
                deviceSelect.appendChild(option);
            });

            // Set the initial manifest path for the flasher when the page loads
            if (devices.length > 0) {
                flasherButton.manifest = devices[0].manifest;
            }

            // Update the manifest path whenever the user selects a different device
            deviceSelect.addEventListener('change', (event) => {
                flasherButton.manifest = event.target.value;
            });

            // Logic for the erase checkbox
            applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            skipEraseCheckbox.addEventListener('change', () => {
                applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            });
            activateBtn.addEventListener('click', () => {
                applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            }, { capture: true });
        });
    </script>

</body>
</html>
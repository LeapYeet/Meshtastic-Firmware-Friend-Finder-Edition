<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Friend Finder Flasher</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f4f7f9;
            --text-color: #333;
            --primary-color: #007bff;
            --container-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        main {
            background-color: var(--container-bg);
            max-width: 700px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: left;
        }

        h1 {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
        }

        p {
            line-height: 1.6;
        }
        
        .intro {
            text-align: center;
            color: #555;
            margin-bottom: 30px;
        }

        .section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        h2 {
            font-size: 1.3em;
            font-weight: 600;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 20px;
        }
        
        h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        ul, ol {
            padding-left: 20px;
        }

        li {
            margin-bottom: 10px;
        }

        .button-container {
            text-align: center;
            margin: 40px 0;
        }

        esp-web-install-button button {
            background-color: var(--primary-color);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        esp-web-install-button button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .options-container {
            margin-top: 20px;
            font-size: 0.9em;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .options-container input:disabled + label {
            color: #aaa;
            cursor: not-allowed;
        }

        .backup-notice, .warning-box {
            background-color: #fffbe6;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 25px 0 0 0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .warning-box {
            background-color: #fff1f0;
            border-left-color: #d9363e;
        }

        .backup-notice p, .warning-box p {
            margin: 0;
        }

        .backup-notice p:first-child {
            margin-bottom: 8px;
        }

        .ui-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .ui-showcase img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .ui-showcase p {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        code {
            background-color: #eef;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        footer {
            margin-top: 50px;
            text-align: center;
            color: #777;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <main>
        <h1>Friend Finder Firmware Flasher</h1>
        <p class="intro">
            Install the custom Meshtastic firmware with Friend Finder & Magnetometer support directly to your Heltec V3.
        </p>
        
        <div class="button-container">
            <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>

            <esp-web-install-button id="flasherButton" manifest="firmware/manifest.json">
                <button id="activateBtn" slot="activate">Connect & Install Firmware</button>
            </esp-web-install-button>
            
            <div class="options-container">
                <input type="checkbox" id="skipErase" name="skipErase" disabled />
                <label for="skipErase">Skip full erase (coming soon)</label>
            </div>
            
            <div class="backup-notice">
                <p><strong>Important:</strong> The "skip erase" feature will be added soon. For now, flashing the firmware will perform a **full erase** of the device.</p>
                <p>Please back up your settings and channel keys using the Meshtastic app or CLI before you proceed.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>‚ú® UI Showcase</h2>
            <div class="ui-showcase">
                <div>
                    <img src="img/tracking_with_mag_info.jpg" alt="Tracking screen with magnetometer">
                    <p>Tracking with a magnetometer</p>
                </div>
                <div>
                    <img src="img/tracking_no_mag_info.jpg" alt="Tracking screen without magnetometer">
                    <p>Tracking without a magnetometer</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Hardware Requirements</h2>
            <p>This firmware requires a **Heltec V3** and a GPS module. For the directional arrow, a magnetometer is highly recommended.</p>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Model / Specification</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Primary Device</strong></td>
                        <td>Heltec Wireless Tracker (V3)</td>
                        <td>Other ESP32-S3 devices are untested.</td>
                    </tr>
                    <tr>
                        <td><strong>GPS Module</strong></td>
                        <td>Any Meshtastic-compatible GPS</td>
                        <td><strong>Required.</strong> The u-blox M8N is recommended.</td>
                    </tr>
                    <tr>
                        <td><strong>Magnetometer</strong></td>
                        <td>QMC5883L</td>
                        <td><strong>Highly Recommended</strong> for the directional arrow. Must be wired to the primary I¬≤C bus (SDA: 41, SCL: 42).</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üìã Instructions & Calibration Guide</h2>
            
            <h3>1. Installation</h3>
            <ol>
                <li>Plug your <strong>Heltec V3</strong> into your computer.</li>
                <li>Click the <strong>Connect & Install</strong> button at the top of the page.</li>
                <li>Select the correct <strong>COM/Serial Port</strong> from the pop-up window and click ‚ÄúConnect‚Äù.</li>
                <li>The installation will begin. Keep this browser tab open until it completes.</li>
            </ol>

            <h3>2. Magnetometer Calibration (Essential!)</h3>
            <p>A proper compass calibration is **crucial** for the directional arrow to be accurate. Perform these steps outdoors, away from large metal objects.</p>
            
            <h4>Step A: Figure-8 Calibration</h4>
            <ol>
                <li>On the device, navigate to `Friend Finder` -> `Compass Cal` -> `Figure-8 Cal`.</li>
                <li>For 15 seconds, slowly move the device in a large figure-8 pattern, twisting and rotating your wrist to point the device in every possible direction.</li>
            </ol>
            
            <h4>Step B: Flat-Spin Calibration</h4>
            <ol>
                <li>Go to `Friend Finder` -> `Compass Cal` -> `Flat-Spin Cal`.</li>
                <li>Place the device on a flat, non-metallic surface.</li>
                <li>For 12 seconds, smoothly rotate the device **CLOCKWISE** for at least 2-3 full rotations.</li>
            </ol>
            
            <h3>3. Usage</h3>
             <ol>
                <li>Ensure your GPS has a satellite lock.</li>
                <li>Pair with a friend via `Friend Finder` -> `Start Pairing`.</li>
                <li>Start a session from `Friend Finder` -> `Track a Friend`.</li>
            </ol>
        </div>
        
        <div class="section">
            <h2>ü§î Troubleshooting Tips</h2>
            <ul>
                <li><strong>Arrow points the wrong way:</strong> It's likely pointing 180¬∞ away from your friend. Use the `Flip North` option in the `Compass Cal` menu. If it's still wrong, you probably spun the device counter-clockwise during the Flat-Spin calibration. Redo it carefully in the **clockwise** direction.</li>
                <li><strong>Arrow is erratic or "jumpy":</strong> This indicates magnetic interference. Ensure the magnetometer is mounted away from wires (especially battery leads). Redo the **Figure-8 calibration** away from any metal.</li>
            </ul>
        </div>

        <div class="section warning-box">
            <h2>‚ö†Ô∏è Warning</h2>
            <p>
                Flashing firmware can potentially brick your device. Ensure you have the correct firmware for your specific model and follow all instructions carefully. This firmware is experimental and may have bugs. Use at your own risk. For source code and more, visit the <a href="https://github.com/LeapYeet/firmware" target="_blank">firmware fork</a>.
            </p>
        </div>
    </main>
    
    <footer>
      <p>
        If you find this project useful, consider supporting its development!
      </p>
      <a href="https://ko-fi.com/LeapYeet" target="_blank" title="Support me on Ko-fi">
        <img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;">
      </a>
    </footer>

    <script>
        function applyEraseMode(buttonEl, skipErase) {
            const eraseFirst = !skipErase;
            buttonEl.eraseFirst = eraseFirst;
            if (eraseFirst) {
                buttonEl.setAttribute('erase-first', '');
            } else {
                buttonEl.removeAttribute('erase-first');
            }
            console.log(`[FF Flasher] eraseFirst=${eraseFirst} (skipErase=${skipErase})`);
        }

        customElements.whenDefined('esp-web-install-button').then(() => {
            const flasherButton   = document.getElementById('flasherButton');
            const skipEraseCheckbox = document.getElementById('skipErase');
            const activateBtn     = document.getElementById('activateBtn');
            applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            skipEraseCheckbox.addEventListener('change', () => {
                applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            });
            activateBtn.addEventListener('click', () => {
                applyEraseMode(flasherButton, skipEraseCheckbox.checked);
            }, { capture: true });
        });
    </script>

</body>
</html>